<ion-content class="ion-padding">

  <!-- <ion-row>
    <ion-col size="7" style="display:flex; align-items: center; color: black;">
      <h2 style="font-size: 22px; font-weight: bold; margin: 0;">Prestamos</h2>
    </ion-col>
    <ion-col size="5">
      <ion-item lines="none">
        <ion-avatar slot="end" (click)="openModalProfile()">
          <ion-img src="https://i.pravatar.cc/300?u=c"></ion-img>
        </ion-avatar>
        <ion-label style="padding-left: 10px; color: black;">
          <ion-icon style="font-size: 24px;" name="notifications-outline"></ion-icon>
        </ion-label>
      </ion-item>
    </ion-col>
  </ion-row> -->
  <ion-header class="ion-no-border">
    <ion-toolbar>
      <ion-label>
        <!-- <h2 style="font-weight: bold;">Mis</h2> -->
        <h1 style="font-weight: bold;">Prestamos</h1>
      </ion-label>
      <ion-icon style="font-size: 24px;" color="dark" slot="end" name="notifications-outline"></ion-icon>
      <ion-item slot="end" lines="none">
        <ion-avatar slot="end" (click)="openModal()">
          <ion-img src="https://ionicframework.com/docs/img/demos/avatar.svg"></ion-img>
        </ion-avatar>
      </ion-item>
    </ion-toolbar>
  </ion-header>

  <div class="" style="padding: 10px 32px 20px;">
    <h5 style="font-size: 13px; font-weight: bold; margin:16px 0px; color:gray; text-align: center;">Aprobados 3 / 6</h5>
    <ion-progress-bar [value]="progress"></ion-progress-bar>
  </div>

  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- <ion-item [button]="true" lines="full" class="item-border">
    <ion-label>
      <h4><strong>Monto solicitado</strong></h4>
      <h4 style="margin-top: 10px;"><strong>Fecha solicitada</strong></h4>
    </ion-label>
    <ion-label>
      <p style="text-align: end; font-weight: bold;">$13,000</p>
      <p style="text-align: end; font-weight: bold; margin-top: 10px;">08/01/2025</p>
    </ion-label>
  </ion-item> -->

  <ion-item-group *ngFor="let data of results">
    <ion-item-divider lines="none">
      <ion-label>{{data.titulo}}</ion-label>
    </ion-item-divider>
  
    <div *ngFor="let p of data.prestamos" (click)="setModalInfo(true,p)" class="card-prestamo" [ngStyle]="{'border-color': p.estado === 'Pendiente' ? '#93BFCF' : p.estado === 'Rechazado' ? '#EEE9DA' : ''}">
      <ion-grid style="padding: 1px 8px;">
        <ion-row>
          <ion-col class="ion-no-padding" style="display: flex; align-items: center;">
            <img src="../../assets/游붅 icon _money prestamo_.svg" width="16px" height="16px">
            <h5 style="font-size: 11px; font-weight: bold; margin:7px 6px;">Monto solicitado</h5>
          </ion-col>
          <ion-col class="ion-no-padding">          
            <h5 style="font-size: 11px; font-weight: bold; margin:7px 6px; text-align: end; color:gray;">${{p.saldo | moneyTransform}}</h5>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col class="ion-no-padding" style="display: flex; align-items: center;">
            <img src="../../assets/游붅 icon _calendar prestamo_.svg" width="16px" height="16px">
            <h5 style="font-size: 11px; font-weight: bold; margin:7px 6px;">Fecha solicitada</h5>
          </ion-col>
          <ion-col class="ion-no-padding">
            <h5 style="font-size: 11px; font-weight: bold; margin:7px 6px; text-align: end; color:gray;">{{p.createdAt | date: 'dd/MM/yyyy'}}</h5>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>
    <!-- <ion-item lines="none">
      <ion-label>Armenia</ion-label>
    </ion-item> -->
  </ion-item-group>

  <ion-modal
      #modal
      [isOpen]="openModalInfo"
      [initialBreakpoint]="0.60"
      [breakpoints]="[0,0.35,0.60,1]"
      cssClass='custom-modal'
      (willDismiss)="onWillDismiss()"
      (ionModalDidDismiss)="noPaymentChange = true"
      (ionModalDidPresent)="onModalPresented()"
      [canDismiss]="canDismiss"
      [backdropDismiss]="backdropDismiss"
      (ionBreakpointDidChange) = "changeListener($event)"
      [expandToScroll]="false"
    >
    <ng-template>
      <ion-content class="ion-padding modal-content" (click)="modal.setCurrentBreakpoint(1)">

        <!-- <h5 style="font-size: 18px; font-weight: bold; text-align: center; margin-top: 32px; margin-bottom: 20px;">Detalle de Prestamo</h5> -->
          <ion-text>
            <p style="text-align: center; font-weight: bold; font-size: 16px; margin: 32px 0px 14px 0px">Detalle prestamo</p>
          </ion-text>
          <ion-text style="text-align: center; font-weight: bold;" color="dark">
            <h1>${{modalInfo.saldo | moneyTransform}}.00 MX</h1>
          </ion-text>
          <ion-text color="medium">
            <p style="text-align: center; font-weight: bold; font-size: 12px; margin: 0px 0px 28px 0px">Monto solicitado</p>
          </ion-text>
          
          <ion-item style="margin-top: 15px;">
            <ion-avatar slot="end">
              <img *ngIf="srcImageName(modalInfo.id_cliente?.evidencia_aval, 'foto-perfil') as image" alt="Silhouette of a person's head" [src]="image.url ? image.url : 'https://ionicframework.com/docs/img/demos/avatar.svg'" />
            </ion-avatar>
            <ion-label>
              <h4 style="font-weight: bold;">{{modalInfo.id_cliente.nombre}}</h4>
              <p>Prestatario / Cliente</p>
            </ion-label>
          </ion-item>
          <ion-label>
            <p style="margin-left: 12px; margin-top: 10px; font-size: 12px; font-weight: bold; color: var(--ion-color-darkmain);">
              <ion-icon name="woman" color="darkmain"></ion-icon>
               Prestamista: {{modalInfo.id_asesor.nombre}}
            </p> 
          </ion-label>
          <!-- <ion-item lines="full" style="margin-top: 10px;">
            <ion-avatar slot="start">
              <img alt="Silhouette of a person's head" src="https://ionicframework.com/docs/img/demos/avatar.svg" />
            </ion-avatar>
            <ion-label>
              <h4>Guadalupe Pichardo Zapata</h4>
              <p>Prestatario / Cliente</p>
              <p style="font-size: 12px; font-weight: bold; color: #93BFCF;">
                <ion-icon name="woman" style="color: #93BFCF;"></ion-icon>
                Prestamista: Marco Young Rivera Reyes
              </p>
            </ion-label>
          </ion-item> -->

          <!-- <h5 style="font-size: 14px; font-weight: bold; text-align: center; margin-top: 32px;">Pendiente: ${{ (modalInfo.totalCuota + modalInfo.totalMultas + modalInfo.totalPendiente) - (modalInfo.totalPagado) | moneyTransform}}.00 <span style="color: #CACACA;">| {{modalInfo.estado}}</span></h5> -->


          <ion-accordion-group style="margin-top: 25px; border: solid 1px #CACACA; border-radius: 10px;" [multiple]="true" [value]="['first', 'second', 'third']">
            <ion-accordion style="border-radius: 10px;" value="first">
              <ion-item slot="header">
                <ion-label style="margin: 0px;"><p style="font-weight: bold;">Informacion general</p></ion-label>
              </ion-item>
              <div class="ion-padding" style="padding-top: 0px;" slot="content">
                <ion-list>
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">Fecha de prestamo:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">
                      {{modalInfo.fecha_prestamo? modalInfo.fecha_prestamo : modalInfo.createdAt | date:'dd/MM/yyyy'}}</p>
                  </div>
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">Monto solicitado:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">
                      ${{modalInfo.saldo | moneyTransform}}.00</p>
                  </div>
                  <!-- <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">Esquema de pago:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">
                      {{modalInfo.tipo_pago}}</p>
                  </div> -->
                  <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">Esquema de pago:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">
                      {{modalInfo.tipo_pago}} a {{modalInfo.periodo}} pagos</p>
                  </div>
                  <!-- <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">N칰mero de pagos:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">
                      {{modalInfo.periodo}}</p>
                  </div> -->
                  <!-- <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">Retrasos:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">0</p>
                  </div> -->
                  <div *ngIf="modalInfo.periodo == 14"
                    style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 0px;">D칤a de pago:</p>
                    <p style="font-size: 12px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">
                      {{modalInfo.dia_pago == 'lunes' ? 'Lunes' : modalInfo.dia_pago == 'sabado' ? 'S치bado' : ''}}</p>
                  </div>
                </ion-list>
              </div>
            </ion-accordion>
          </ion-accordion-group>

          <!-- <ion-button (click)="toggleAccordion('0')">Abrir pago</ion-button> -->
          
          <ion-segment color="darkmain" [value]="segmentValue">
            <ion-segment-button value="tabla" (click)="backSlide()">
              <ion-label>Tabla</ion-label>
            </ion-segment-button>
            <ion-segment-button value="historial" (click)="goSlide()">
              <ion-label>Actividad</ion-label>
            </ion-segment-button>
          </ion-segment>
          <ion-item-divider></ion-item-divider>
          <swiper-container
            #swiper
            (afterinit)="swiperReady()"
            (swiperslidechange)="swiperSlideChanged($event)"
          >
            <swiper-slide>
              <!-- <ion-item>
                <ion-label *ngIf="modalInfo?.tabla_amortizacion.length>0" class="ion-padding" style="padding: 16px; margin-top: 8px; display: block;">
                Tabla amortizaci칩n
                <p>Administrador</p>
                </ion-label>
                <ion-note slot="end">Retrasos(0)</ion-note>
              </ion-item> -->
              <ion-grid style="padding: 5px 0px;" *ngIf="modalInfo?.tabla_amortizacion.length>0">
                <ion-row style="font-size: 11px; font-weight: bold; text-align: center; border-top: 1px solid #CACACA; border-bottom: 1px solid #CACACA;">
                  <ion-col size="1"></ion-col>
                  <ion-col size="2"># Pago</ion-col>
                  <ion-col size="3">Fecha pago</ion-col>
                  <ion-col size="3">Monto</ion-col>
                  <ion-col size="3">Estado pago</ion-col>
                </ion-row>
                
                <ion-row *ngFor="let pago of modalInfo.tabla_amortizacion; let i = index" class="ion-align-items-center" style="font-size: 11px; font-weight: bold; text-align: center; color: #CACACA; border-bottom: 1px solid #CACACA;">
                  <ion-col button size="1">
                    <ion-checkbox class="checkSuccess ion-checkbox-success" 
                    (ionChange)="setPagoEstado(pago, $event, 'Pagado', i)" 
                    [disabled]="pago.retraso || pago.completed || pago.pendiente" 
                    [ngClass]="{'checkRetrazo ion-checkbox-retrazo': pago.retraso , 'checkPendiente ion-checkbox-pendiente' : pago.estado_pago == 'Pendiente'}" 
                    [indeterminate]="pago.retraso || pago.estado_pago == 'Pendiente'" 
                    [checked]="pago.estado_pago == 'Pagado'? true : false"></ion-checkbox>
                  </ion-col>
                  <ion-col style="padding-right: 0px;" size="11">
                    <ion-accordion-group #accordionGroup (ionChange)="accordionGroupChange($event)">
                      <ion-accordion [value]="i">
                        <ion-item slot="header" color="none" class="ion-no-padding" style="--inner-padding-end: 0; text-align: center; font-size: 14px;">
                          <ion-col size="2">{{pago.num_pago}}</ion-col>
                          <ion-col >{{pago.fecha_pago | date: 'dd/MM/yyyy'}}</ion-col>
                          <ion-col >${{pago.cuota | moneyTransform}}</ion-col>
                          <ion-col >{{pago.estado_pago}}</ion-col>
                        </ion-item>
                        <div class="" slot="content">
    
                          <ion-item-divider></ion-item-divider>
    
                          <ion-list class="" style="padding-top: 0px;">
                            
                            <ion-list-header style="text-align: start;">
                              <ion-label>Detalles de pago</ion-label>
                            </ion-list-header>
    
                            <ion-item class="ion-item-custom" lines="none">
                              <small>Estado modificaci칩n</small>
                              <ion-badge slot="end" 
                                [ngClass]=" pago.completed ? 'ion-badge-success' : pago.retraso ? 'ion-badge-nopaid' : pago.pendiente ? 'ion-badge-pendig' : 'ion-badge-opened' "
                                >
                                {{pago?.completed ? 'completo' : pago?.retraso ? 'retrasado' : pago?.pendiente ? 'pendiente' : 'abierto'}}
                              </ion-badge>
                            </ion-item>
                            <ion-item class="ion-item-custom" lines="none">
                              <small>{{pago?.completed || pago?.retraso || pago?.pendiente ? 'Expir칩' : 'Expira'}}</small>
                              <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px;" slot="end">{{pago.fecha_pago | date: 'mediumDate':locale}} (08:00pm)</ion-note>
                            </ion-item>
                            <ion-item *ngIf="pago?.retraso" class="ion-item-custom" lines="none">
                              <small>Saldo pediente</small> <!-- MULTAS -->
                              <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px;" slot="end">${{pago.multa.saldado ? 0 : pago.multa.monto_pendiente + pago.cuota | moneyTransform}}</ion-note>
                            </ion-item>
                            <ion-item *ngIf="pago.abono_pago" class="ion-item-custom" lines="none">
                              <small>Saldo pediente</small> <!-- ABONO MALO -->
                              <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px;" slot="end">${{pago.saldo_pendiente | moneyTransform}}</ion-note>
                            </ion-item>
                            <ion-item *ngIf="pago?.retraso" class="ion-item-custom" lines="none">
                              <small>Dias de retraso</small>
                              <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px;" slot="end">{{pago.multa.dia_retraso}}</ion-note>
                            </ion-item>
                            <ion-item *ngIf="pago.multa?.fecha_pago" class="ion-item-custom" lines="none">
                              <small>Fecha en que se saldo</small>
                              <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px;" slot="end">{{pago.multa?.fecha_pago | date: 'mediumDate':locale}}</ion-note>
                            </ion-item>
                            <ion-item *ngIf="pago.pendiente && pago.abono_pago" class="ion-item-custom" lines="none">
                              <small>Abono recibido</small>
                              <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px;" slot="end">${{pago.abono_pago | moneyTransform}}</ion-note>
                            </ion-item>
                            <ion-item *ngIf="pago?.completed || pago?.pendiente" class="ion-item-custom" lines="none">
                                <small style="margin-right: 65px;" slot="start">Notas</small>
                                <ion-note color="dark" class="ion-no-margin ion-no-padding" style="margin-top: 10px; margin-bottom: 10px; text-align: end;" slot="end">{{pago.notas ? pago.notas : 'Sin notas'}}</ion-note>
                            </ion-item>
                            <ion-item *ngIf="!pago?.completed && !pago?.retraso && !pago?.pendiente && pago.estado_pago != 'Pagado'" style="min-height: 10px;" class="no-ripple" lines="none">
                              <ion-checkbox 
                                (ionChange)="setPagoEstado(pago, $event, 'Pendiente', i)" 
                                [checked]="pago.abono_pago"  
                                style="margin-right: 10px;" 
                                class="checkNormal ion-checkbox-normal" 
                                slot="start">
                              </ion-checkbox>
                              <small slot="start" style="margin-right: 28px;">쯇ermitir abono?</small>
                              <input (input)="checarBono($event, pago)" *ngIf="bonoCheck[i] || pago.abono_pago" [(ngModel)]="pago.abono_pago" class="bono" type="Number" placeholder="$00.00">
                            </ion-item>
                            
                            <ion-item *ngIf="!pago?.completed && !pago?.retraso && !pago?.pendiente" class="ion-item-custom" lines="none">
                              <ion-label style="margin-bottom: 0px;">
                                <small style="margin-bottom: 5px;">Notas</small>
                                <ion-textarea [(ngModel)]="pago.notas" (ionInput)="checarNotas()" (ionFocus)="textAreaFocused = i" (ionBlur)="textAreaFocused = null" [ngClass]="{'focused': textAreaFocused === i}" class="ion-no-padding" aria-label="Comments" placeholder="Escribe tus comentarios aqu칤..."></ion-textarea>
                              </ion-label>
                            </ion-item>

                            <!-- <ion-item *ngIf="!pago.multa.saldado && pago.retraso" lines="none">
                              <ion-icon size="small" color="danger" slot="start" name="time-outline" size="large"></ion-icon>
                              <ion-label>
                                <ion-note>Dias de retraso: </ion-note>
                                <ion-note>{{pago.multa.dia_retraso}}</ion-note>
                              </ion-label> -->
                              <ion-button *ngIf="!pago.multa.saldado && pago.retraso" [disabled]="pago.multa.saldado" size="small" expand="block" color="medium" (click)="pagarMultaPago(modalInfo._id,pago.num_pago, pago.multa.monto_pendiente + pago.cuota, i)">Pagar multa</ion-button>
                            <!-- </ion-item> -->
    
                          </ion-list>
                        </div>
                      </ion-accordion>
                    </ion-accordion-group>
                  </ion-col>
                </ion-row>
              </ion-grid>
              <div *ngIf="modalInfo.estado == 'Pendiente' " style="margin-top: 20px;">
                <ion-button expand="block" color="darkmain" (click)="aceptarPrestamo(modalInfo)">Aceptar prestamo</ion-button> 
                <ion-button expand="block" color="darkmain" fill="outline" (click)="rechazarPrestamo(modalInfo._id)">Rechazar prestamo</ion-button>
              </div>
            </swiper-slide>
            <swiper-slide>
              <ion-label *ngIf="modalInfo?.tabla_amortizacion.length>0" class="ion-padding" style="padding: 16px; margin-top: 8px; display: block;">
                Historial de pagos
                <!-- <p>Administrador</p> -->
              </ion-label>

              <ion-list [inset]="true">
                <div *ngFor="let pago of modalInfo.tabla_amortizacion.slice(0,4); let i = index">
                  <ion-item *ngIf="!pago.hasOwnProperty('abierto') || pago.estado_pago == 'Pagado' || pago.abono_pago " [button]="true" detail="false">
                    <ion-label>
                      <strong>Pago {{pago.num_pago}}</strong><br/>
                      <ion-text>Estado: {{pago.estado_pago}}</ion-text><br/>
                      <ion-note color="medium" class="ion-text-wrap">
                        <span *ngIf="pago.estado_pago == 'Pagado' || pago.estado_pago == 'Pendiente'">+</span>
                        <span *ngIf="pago.estado_pago == 'No pagado'">-</span>
                        ${{pago.estado_pago == 'Pendiente'? pago.abono_pago : pago.cuota | moneyTransform}}.00
                      </ion-note>
                      <div *ngIf="pago.multa.dia_retraso > 0">
                        <ion-text>Multas</ion-text><br/>
                        <div *ngIf="pago.multa.multasArray.length > 4">
                          <ion-note color="medium" class="ion-text-wrap">- ${{pago.multa.multasArray[0] | moneyTransform}}.00 (x{{pago.multa.multasArray.length}})</ion-note><br/>
                        </div>
                        <div *ngIf="pago.multa.dia_retraso <= 4">
                          <span *ngFor="let m of pago.multa.multasArray">
                            <ion-note color="medium" class="ion-text-wrap">- ${{m | moneyTransform}}.00</ion-note><br/>
                          </span>
                        </div>

                        <!-- <ion-accordion-group>
                          <ion-accordion value="first">
                            <ion-item slot="header">
                              <ion-label>Ver mas...</ion-label>
                            </ion-item>
                            <div slot="content">
                              <span *ngFor="let m of pago.multa.multasArray">
                                <ion-note color="medium" class="ion-text-wrap">- ${{m | moneyTransform}}.00</ion-note><br/>
                              </span>
                            </div>
                          </ion-accordion> 
                        </ion-accordion-group> -->
                        <ion-text *ngIf="pago.multa.saldado">Liquidacion de multas: </ion-text> <ion-note color="medium" class="ion-text-wrap"> {{pago.multa.fecha_pago | date: 'dd/MM/yyyy'}}</ion-note>
                      </div>
                      <div *ngIf="pago.saldo_pendiente">
                        <br/><ion-text>Pendiente</ion-text><br/>
                        <ion-note color="medium" class="ion-text-wrap">- ${{pago.saldo_pendiente | moneyTransform}}.00</ion-note><br/>
                      </div>
                    </ion-label>
                    <div class="metadata-end-wrapper" slot="end">
                      <ion-note color="medium">{{pago.fecha_pago | date: 'dd/MM/yyyy'}}</ion-note>
                      <ion-icon color="medium" name="chevron-forward"></ion-icon>
                    </div>
                  </ion-item>
                </div>
                <div *ngIf="showMore">
                  <div *ngFor="let pago of modalInfo.tabla_amortizacion.slice(4); let i = index">
                    <ion-item *ngIf="!pago.hasOwnProperty('abierto') || pago.estado_pago == 'Pagado' || pago.abono_pago " [button]="true" detail="false">
                      <ion-label>
                        <strong>Pago {{pago.num_pago}}</strong><br/>
                        <ion-text>Estado: {{pago.estado_pago}}</ion-text><br/>
                        <ion-note color="medium" class="ion-text-wrap">
                          <span *ngIf="pago.estado_pago == 'Pagado' || pago.estado_pago == 'Pendiente'">+</span>
                          <span *ngIf="pago.estado_pago == 'No pagado'">-</span>
                          ${{pago.estado_pago == 'Pendiente'? pago.abono_pago : pago.cuota | moneyTransform}}.00
                        </ion-note>
                        <div *ngIf="pago.multa.dia_retraso > 0">
                          <ion-text>Multas</ion-text><br/>
                          <div *ngIf="pago.multa.multasArray.length > 4">
                            <ion-note color="medium" class="ion-text-wrap">- ${{pago.multa.multasArray[0] | moneyTransform}}.00 (x{{pago.multa.multasArray.length}})</ion-note><br/>
                          </div>
                          <div *ngIf="pago.multa.dia_retraso <= 4">
                            <span *ngFor="let m of pago.multa.multasArray">
                              <ion-note color="medium" class="ion-text-wrap">- ${{m | moneyTransform}}.00</ion-note><br/>
                            </span>
                          </div>
  
                          <!-- <ion-accordion-group>
                            <ion-accordion value="first">
                              <ion-item slot="header">
                                <ion-label>Ver mas...</ion-label>
                              </ion-item>
                              <div slot="content">
                                <span *ngFor="let m of pago.multa.multasArray">
                                  <ion-note color="medium" class="ion-text-wrap">- ${{m | moneyTransform}}.00</ion-note><br/>
                                </span>
                              </div>
                            </ion-accordion> 
                          </ion-accordion-group> -->
                          <ion-text *ngIf="pago.multa.saldado">Liquidacion de multas: </ion-text> <ion-note color="medium" class="ion-text-wrap"> {{pago.multa.fecha_pago | date: 'dd/MM/yyyy'}}</ion-note>
                        </div>
                        <div *ngIf="pago.saldo_pendiente">
                          <br/><ion-text>Pendiente</ion-text><br/>
                          <ion-note color="medium" class="ion-text-wrap">- ${{pago.saldo_pendiente | moneyTransform}}.00</ion-note><br/>
                        </div>
                      </ion-label>
                      <div class="metadata-end-wrapper" slot="end">
                        <ion-note color="medium">{{pago.fecha_pago | date: 'dd/MM/yyyy'}}</ion-note>
                        <ion-icon color="medium" name="chevron-forward"></ion-icon>
                      </div>
                    </ion-item>
                  </div>
                </div>

                <!-- Show More / Show Less Button -->
                <ion-button *ngIf="modalInfo.tabla_amortizacion.length > 4" expand="block" color="darkmain" fill="outline" (click)="toggleShowMore()">
                  {{ showMore ? 'Mostrar menos' : 'Mostrar m치s' }}
                </ion-button>


                <!-- <ion-item [button]="true" detail="false">
                  <ion-label>
                    <strong>Pago 1</strong><br/>
                    <ion-text>Estado: Pagado</ion-text><br/>
                    <ion-note color="medium" class="ion-text-wrap">
                      + $2,500.00
                    </ion-note>
                  </ion-label>
                  <div class="metadata-end-wrapper" slot="end">
                    <ion-note color="medium">03/25/2025</ion-note>
                    <ion-icon color="medium" name="chevron-forward"></ion-icon>
                  </div>
                </ion-item> -->
              </ion-list>
              <ion-label *ngIf="modalInfo?.tabla_amortizacion.length>0" class="ion-padding" style="padding: 16px; margin-top: 8px; display: block;">
                Metricas
              </ion-label>

              <ion-list style="padding: 10px 28px;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 0px;">Subtotal:</p>
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">${{modalInfo.totalCuota | moneyTransform}}.00</p>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 0px;">Multas:</p>
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">${{modalInfo.totalMultas | moneyTransform}}.00</p>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 0px;">Pagos pendientes:</p>
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">${{modalInfo.totalPendiente | moneyTransform}}.00</p>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 0px;">Total Pagado:</p>
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">${{modalInfo.totalPagado | moneyTransform}}.00</p>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 4px;">
                  <p style="font-size: 16px; font-weight: bold; margin: 8px 0px 0px 0px;">Deuda Total:</p>
                  <p style="font-size: 14px; font-weight: bold; margin: 8px 0px 0px 8px; color: gray; text-align: right;">${{modalInfo.totalMultas + modalInfo.totalPendiente | moneyTransform}}.00</p>
                </div>
              </ion-list>
            </swiper-slide>
          </swiper-container>

        </ion-content>
        <ion-progress-bar *ngIf="updatingPago" type="indeterminate" color="darkmain"></ion-progress-bar>
        <ion-footer *ngIf="!noPaymentChange">
          <ion-toolbar>
            <ion-title style="margin-top: 10px;"><small>쮾uardar cambios realizados?</small></ion-title>
            <ion-row>
              <ion-col><ion-button expand="block" color="darkmain" [disabled]="updatingPago"
                  (click)="updateTablaAmortz(modalInfo)">Guardar</ion-button></ion-col>
              <ion-col><ion-button expand="block" color="darkmain" [disabled]="updatingPago" fill="outline"
                  (click)="cancelPut()">Cancelar</ion-button></ion-col>
              </ion-row>
            </ion-toolbar>
        </ion-footer>
        <ion-progress-bar *ngIf="accept_reject" type="indeterminate" color="darkmain"></ion-progress-bar>

        <ion-footer class="ion-padding" *ngIf="(modalInfo.totalCuota + modalInfo.totalMultas + modalInfo.totalPendiente) - (modalInfo.totalPagado) == 0">
          <ion-toolbar>
            <ion-button expand="block" color="darkmain" size="large" (click)="cerrarPrestamo(modalInfo)">Cerrar pago</ion-button>
          </ion-toolbar>
        </ion-footer>
      </ng-template>
  </ion-modal>
  
  <!-- Modal to add a new Prestamo -->
  <ion-modal [isOpen]="isModalOpenAdd" >
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button size="small" style="color: gray;" [strong]="true" [disabled]="postingPrestamo" (click)="setOpenAdd(false,rollModal)">Cancelar</ion-button>
          </ion-buttons>
          <!-- <ion-title>Nuevo Asesor</ion-title> -->
          <h5 style="text-align: center; font-size: 16px; font-weight: bold;">Solicitar Prestamo</h5>
          <ion-buttons slot="end">
            <ion-button size="small" style="color: rgba(147, 191, 207, 1);" [strong]="true" [disabled]="postingPrestamo" (click)="submitAddPrestamo()">{{rollModal}}</ion-button>
          </ion-buttons>
          <ion-progress-bar *ngIf="postingPrestamo" type="indeterminate"></ion-progress-bar>
        </ion-toolbar>
      </ion-header>
      <ion-content>

        <form [formGroup]="formInputPOST" #formDirective="ngForm">
          <section class="ion-padding">
            <!-- First part of formular -->
            <div style="padding-top: 6%;">
              <h5 style="font-size: 12px; font-weight: bold; margin:0px; padding-bottom: 6px; color:gray;">Monto solicitado</h5>
              <div class="ion-no-margin"><input class="input-form" type="number" formControlName="saldo" placeholder="M치x. cantidad $24,000.00"></div>
              <small class="invalid" *ngIf="formSubmit && formInputPOST.get('saldo')?.status == 'INVALID'">Ingresa un monto valido</small>
            </div>
            <div style="padding-top: 4%;">
              <h5 style="font-size: 12px; font-weight: bold; margin:0px; padding-bottom: 6px; color:gray;">Selecciona un periodo</h5>
              <ion-list class="ion-no-padding">
                <ion-item class="select-form" lines="none">
                  <ion-select formControlName="periodo" aria-label="periodos" placeholder="Selecciona el periodo">
                    <ion-select-option value="14">14 semanas</ion-select-option>
                    <ion-select-option value="6">6 meses</ion-select-option>
                    <ion-select-option value="3">3 meses</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-list>
              <small class="invalid" *ngIf="formSubmit && formInputPOST.get('periodo')?.status == 'INVALID'">Ingresa un monto valido</small>
            </div>
            <div style="padding-top: 4%;">
              <h5 style="font-size: 12px; font-weight: bold; margin:0px; padding-bottom: 6px; color:gray;">Cliente asignado</h5>
            </div>
            <ion-list class="select-form ion-no-padding" [inset]="true">
              <ion-item [button]="true" [detail]="false" id="select-clientes">
                <ion-label style="font-size: 16px;">Beneficiario</ion-label>
                <div slot="end" id="selected-clientes" style="color: #CACACA;font-size: 14px;font-weight: bold;">{{ selectedClientesText }}</div>
              </ion-item>
            </ion-list>
            <small class="invalid" *ngIf="formSubmit && formInputPOST.get('id_cliente')?.status == 'INVALID'">Selecciona un cliente</small>

            <div style="padding-top: 4%;" *ngIf="this.formInputPOST.value?.periodo == 14">
              <h5 style="font-size: 12px; font-weight: bold; margin:0px; padding-bottom: 6px; color:gray;">D칤a de pago</h5>
              <ion-list class="ion-no-padding">
                <ion-item class="select-form" lines="none">
                  <ion-select formControlName="dia_pago" aria-label="periodos" placeholder="Selecciona el periodo">
                    <ion-select-option value="lunes">Lunes</ion-select-option>
                    <ion-select-option value="sabado">S치bado</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-list>
              <small class="invalid" *ngIf="formSubmit && formInputPOST.value.dia_pago == '' || formInputPOST.value.dia_pago == null">Selecciona un d칤a de cobro</small>
            </div>
  
            <ion-modal trigger="select-clientes" #modal_cli>
              <ng-template>
                <app-cliente-modal
                  class="ion-page"
                  title="MIS CLIENTES"
                  [items]="clientes"
                  [selectedItems]="selectedClientes"
                  (selectionChange)="clienteSelectionChanged($event)"
                  (selectionCancel)="this.modal_cli.dismiss()"
                ></app-cliente-modal>
              </ng-template>
            </ion-modal>
  
          </section>
        </form>

      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Modal for filter -->
  <ion-modal #modal_filter trigger="filter-modal" [initialBreakpoint]="0.7" [breakpoints]="[0, 0.4, 0.7, 0.9]" [isOpen]="isModalFilter">
    <ng-template>
      <ion-content class="ion-padding">

        <ion-accordion-group style="margin-top: 15px;" [multiple]="true" [value]="['first', 'second', 'third', 'forth']">
          <ion-accordion value="first">
            <ion-item slot="header">
              <ion-label><p>Estados</p></ion-label>
            </ion-item>
            <div class="" slot="content">
              <ion-chip color="darkmain" (click)="toggleEstado('Aceptado')">
                Aceptado <ion-icon *ngIf="selectedEstados.includes('Aceptado')" name="checkmark-outline"></ion-icon>
              </ion-chip>
              <ion-chip color="darkmain" (click)="toggleEstado('Pendientes')">
                Pendientes <ion-icon *ngIf="selectedEstados.includes('Pendientes')" name="checkmark-outline"></ion-icon>
              </ion-chip>
              <ion-chip color="darkmain" (click)="toggleEstado('Rechazados')">
                Rechazados <ion-icon *ngIf="selectedEstados.includes('Rechazados')" name="checkmark-outline"></ion-icon>
              </ion-chip>
              <ion-chip color="darkmain" (click)="toggleEstado('Cerrados')">
                Cerrados <ion-icon *ngIf="selectedEstados.includes('Cerrados')" name="checkmark-outline"></ion-icon>
              </ion-chip>
            </div>
          </ion-accordion>
          <ion-accordion value="second">
            <ion-item slot="header">
              <ion-label><p>Monto de prestamo</p></ion-label>
            </ion-item>
            <div class="ion-padding" slot="content">
              <ion-range 
                aria-label="Temperature"
                [min]="1"
                [max]="5"
                [value]="2"
                [pin]="true"
                [ticks]="true"
                [snaps]="true"
                [pinFormatter]="pinFormatter"
                (ionChange)="catchRange($event)"
              >
              </ion-range>
            </div>
          </ion-accordion>
          <ion-accordion value="third">
            <ion-item slot="header">
              <ion-label><p>Presonal</p></ion-label>
            </ion-item>
            <div class="" slot="content">

              <ion-list class="ion-no-padding" style="margin: 6px; border-radius: 10px;" [inset]="true">
                <ion-item [button]="true" [detail]="false" [color]="selectedClientes.length == 0? 'light' : 'darkmain'">
                  <ion-icon name="cash-outline" *ngIf="selectedClientes.length == 0" slot="start"></ion-icon>
                  <ion-icon name="close-circle" *ngIf="selectedClientes.length > 0" slot="start" (click)="removeCliSelection()"></ion-icon>
                  <ion-label style="font-size: 14px;">Cliente</ion-label>
                  <div id="select-clientes" slot="end" style="color: #CACACA;font-size: 14px;font-weight: bold;">
                    <p>{{selectedClientesText }}</p></div>
                  <ion-icon *ngIf="selectedClientes.length > 0" slot="end" name="checkmark-outline"></ion-icon>
                </ion-item>
              </ion-list>
              
              <ion-modal trigger="select-clientes" #modal_cli>
                <ng-template>
                  <app-cliente-modal class="ion-page" title="MIS CLIENTES" [items]="clientes" [selectedItems]="selectedClientes"
                    (selectionChange)="clienteSelectionChanged($event)" (selectionCancel)="this.modal_cli.dismiss()">
                  </app-cliente-modal>
                </ng-template>
              </ion-modal>

              <!-- id="select-asesores" es el trigger para abrir asesores modal component -->
              <ion-list class="ion-no-padding" style="margin: 6px; border-radius: 10px;" [inset]="true">
                <ion-item [button]="true" [detail]="false" [color]="selectedAsesores.length == 0? 'light' : 'darkmain'">
                  <ion-icon name="woman-outline" *ngIf="selectedAsesores.length == 0" slot="start"></ion-icon>
                  <ion-icon name="close-circle" *ngIf="selectedAsesores.length > 0" slot="start" (click)="removeAseSelection()"></ion-icon>
                  <ion-label style="font-size: 14px;">Asesor</ion-label>
                  <div id="select-asesores" slot="end" style="color: #CACACA;font-size: 14px;font-weight: bold;">
                    {{selectedAsesoresText}}</div>
                  <ion-icon *ngIf="selectedAsesores.length > 0" slot="end" name="checkmark-outline"></ion-icon>
                </ion-item>
              </ion-list>
              
              <ion-modal trigger="select-asesores" #modal_ase>
                <ng-template>
                  <app-cliente-modal class="ion-page" title="MIS ASESORES" [items]="asesores" [selectedItems]="selectedAsesores"
                    (selectionChange)="asesorSelectionChanged($event)" (selectionCancel)="this.modal_ase.dismiss()">
                  </app-cliente-modal>
                </ng-template>
              </ion-modal>
            </div>
          </ion-accordion>
          <ion-accordion value="forth">
            <ion-item slot="header">
              <ion-label><p>Tipo de pago</p></ion-label>
            </ion-item>
            <div class="" slot="content">
              <ion-item lines="none">
                <ion-select label="Mensual / Semanal" placeholder="Selecciona una opcion" [(ngModel)]="filters.tipoPago">
                  <ion-select-option value="Mensual">Mensual</ion-select-option>
                  <ion-select-option value="Semanal">Semanal</ion-select-option>
                </ion-select>
              </ion-item>
            </div>
          </ion-accordion>

        </ion-accordion-group>

        <ion-item class="" lines="none">
          <ion-icon slot="end" name="reload-outline" (click)="refreshFilter()"></ion-icon>
          <ion-button (click)="filterPrestamos(filters)" slot="end" fill="solid" color="darkmain" size="default">Filtrar</ion-button>
        </ion-item>
        

        <!-- <div>
          <div class="ion-padding">Monto</div>
          <ion-text>$4,000 - $ 20,000</ion-text>
          <ion-range aria-label="Range with ticks" [ticks]="true" [snaps]="true" [min]="0" [max]="10"></ion-range>
          <div class="ion-padding">Fecha</div>
        </div> -->
        <!-- <div class="">
          <ion-datetime></ion-datetime>
        </div> -->
        
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- <ion-datetime presentation="date" value="2023-01-01"></ion-datetime> -->
  
  
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button (click)="setOpenAdd(true,'AGREGAR')">
      <ion-icon size="large" name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  <ion-fab style="margin-bottom: 60px;" slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button style="--background: #EEE9DA" size="small" id="filter-modal" (click)="isModalFilter = true">
      <ion-icon style="color: black;" size="large" name="filter-circle-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>
